(defpackage #:qlot/utils/shell
  (:use #:cl)
  (:import-from #:qlot/logger
                #:*debug*
                #:debug-log)
  (:export #:safety-shell-command
           #:shell-command-error
           #:shell-command-error-output
           #:run-lisp
           #:launch-lisp
           #:*qlot-source-directory*))
(in-package #:qlot/utils/shell)

(defparameter *qlot-source-directory*
  (asdf:system-source-directory :qlot))

(define-condition shell-command-error (simple-error)
  ((command :type cons
            :initarg :command)
   (code :type integer
         :initarg :code)
   (stderr :type string
           :initarg :stderr
           :reader shell-command-error-output))
  (:report
   (lambda (condition stream)
     (format stream "Error while executing a shell command: 誉 (Code=D)2%  A"
             (slot-value condition 'command)
             (slot-value condition 'code)
             (slot-value condition 'stderr)))))

(defun safety-shell-command (program args &key (output :string))
  (setf args (mapcar #'princ-to-string args))
  (debug-log "Running shell command: A誉痱镧蜥狎珞蹰镳瑚轸璀翦眇矧狎骈戾ê疳翳钺礤篝溴蝌骈戾后趄遽篝溴蝌轰轵邈糸镱洪铹ㄨ犷潇弪汜箦蹰镳候躅痱镧蜥ㄣ镱痱镧蜥狎珞洪铕豸洪铘弪徙糸鲥猴豸瘐秕麴豸哄蝌矧秕麴豸ㄩ溴怩绐洪铘弪徙糸鲥篝溴蝌骈戾┅蹰镳蝓瞽痱镧蜥砗篚怵蝻沐篌弪蝻ㄥㄥ蝌矧箬屐飙泔眄犷洵弪蝻恒镯磲钿ㄣ镱痱镧蜥狎珞恒镤蹰镳蝓瞽痱镧蜥砗篚怵蝻沐篌弪蝻颦泔溴濠后翡弪蹰镳后祯蝠篝蝈犴篝蜷铉篝溴蝌┅┅┅ㄤ彐躅筢驽豉忉汶珧秕钿泔眄犷痱镧蜥狎珞脲轭瘐秕麴豸箦翩狎珞磲疸狎＇痱轭悱麸篝蜷铉狎珞┅ㄤ邂蹒祜⒁躅铋铉忉汶珧秕钿泔眄犷浜窿誉痱镧蜥狎珞蹰镳红狨钽璀痱镧蜥ㄣ镱痱镧蜥狎珞洪铕豸轭瘐猴豸瘐秕麴豸哄蝌矧秕麴豸后趄遽愆ㄤ彐鲠沲蝌孱舡扉箴疳翳矧＋沣ㄣ狎沣旌泔眄犷洵扉铄狎珲礤铘扉篝＋筲沆ㄣ狎筲屮艉痫箝狎琏＋犰戾珧ㄣ狎簌篝屙恒镯磲钿扉铄狎珲礤铘螬＋沆轶沆轶稷＋沩ㄣ狎屮艉泔眄犷洵扉铄篝蜷铉螵＋邈ㄣ狎箝恒镯磲钿狎珞┅＋徕沆㈥狯幄┅ㄤ彐鲠弼犰镳糸镱矧＋蝻螽轭轸澧＋沣弼犰＋筲沆弼犰＋犰戾珧澧＋沆轶＋沩弼犰＋邈弼犰＋徕沆弼犰┅ㄤ彐躅篝ㄦ矧愆＋筲沆ㄤ邈灬蝈筲屮艉眭骀戾泔钿轸轱铙筲屮艉泔溴溴戾糸镱铒翦┅戾è疳汶徵濯ㄦ轭洵疳汶徵恒飙躞弪┅ㄩ篝蜷铉骘蝽骘蝽戾è痱轭舡汜箦轰秣钽狍濠í痱轭舡痱弭豉铋飑痱轭杯麸篝蜷铉骘蝽┅┅ㄤ彐躅ㄦ矧愆扉篝弼犰镳糸镱篝骘蝽┅ㄤ彐躅溴驷蹯舡狎珞īㄡ痧孱ō蝈聃轵п箐姗ō啜箦翩溴怩珑弪栾镫灬礅溽ㄣ飙躞弪汉沆躞弪汉疳蝈铘ㄤ邈灬蝈ㄩ珙矧沆躞弪汉疳蝈铘┅ㄦ矧磲弪蝻颦秕麴豸ε蝌矧窿ア沆躞弪汉悌括犷溴怩绐Ж蹰镳吼蜷铘忉汶趄徙恒镱溟糸镱沆躞弪汉悌┅蹰镳厚蹰暴┅┅ㄤ彐躅怩殪洵泔眄犷洵狎珞ㄦ矧眢脲祜徜簌篝屙箫躜沐蝈玳篝蝙ㄡ痧孱ㄤ彐狨祠狎珞麒孱箫躜沐蝈玳篝蝙ō啜瘐箬箫躜沐蝈玳篝蝙狍滏邯沐铘蜥飙蝈玳篝蝙┅ōЖ箦翩狍滏汉溴驷蹯舡箫躜沐蝈玳篝蜷弩聃雉ㄡ箐婧哄铞轵镱礤铘箫躜沐蝈玳篝蝙狍滏汉簌篝屙箫躜沐蝈玳篝蝙狍滏汉簌篝屙箫躜沐蝈玳篝蝙溟蝈泗矧┅┅麒孱祜徜ō啜祜徜祜徜┅祜镳骘簌篝屙轭簌篝屙狃疱钿ō啜殒ㄦ轭厚蹰汶扉箴驽狒躜弩蹰镳后礅镬汜祆厚厚蹰汶祜徜簌篝屙后殪孱舂戾è篝犷溽蜾秕麴豸磲脲怛镝溷狍舡篝蝈犴┅í弪蝻颦秕麴豸磲脲怛镝溷狍舡篝蝈犴┅í趄徙瀛秕麴豸磲脲怛镝溷狍舡篝蝈犴┅ㄡ箐婧祜徜簌篝屙簌篝屙┅┅祜镳骘骘蝽轭骘蝽狃疱钿ōㄩ疳翳钺礤骘蝽啜祜徜骘蝽骘蝽┅┅＋蝻螽轭轸ㄤ彐躅痱邈镯磲钿镳糸镱īЖ癣┅－蝻螽轭轸ㄤ彐躅痱邈镯磲钿镳糸镱ī＋徕沆啜赆颌蹰镳侯狒轹瀛钺礤篝蜷铉ㄦ轵篝疳翳钺礤溴鲩沐屮艉扉箴栾礤┅┅＋沣Ж铒轭轸聃殄簪忉翥琚＋筲沆Ж铒轭骘蝽铒簌箝铋簪铒躞弪轭轸铒瞽轭翦蜥泗轹澧＋犰戾珧Ж耨＋沆轶Ж铒蜚聃殄簪箝戾铘镱弪蝻颌㈠轸＋沩Ж铒轭轸＋邈Ж铒蜚＋徕沆Ж铒轭骘蝽铒轭轸┅＋蝻螽轭轸ㄤ彐躅痫篝泔眄犷洵镳糸镱ī铋飑－蝻螽轭轸ㄤ彐躅痫篝泔眄犷洵镳糸镱īō聃雉＋沣ㄣ沆厚蹰舂＋筲沆筲屮艉屮轸＋犰戾珧ㄥ沆哄轸厚蹰弭舂＋沆轶ㄥ艉聃轸＋沩蹉躅轼乎铋屮轸＋邈ㄥ艉聃轸＋徕沆ㄥ艉聃轸－矧沣筲沆犰戾珧沆轶沩蹉邈徕沆ㄣ飙躞弪汉聃轸┅┅ㄤ彐躅泔眄犷洵镳糸镱ㄦ矧眢狎珞ㄡ痧孱痱邈镯磲钿镳糸镱螬ㄡ痧禊＇怩殪洵泔眄犷洵狎珞骘蝽狎珞痫篝泔眄犷洵镳糸镱螬┅ㄤ彐躅灬躅汨扉箴ㄦ矧眢蝈篝狎珞脲祜徜簌篝屙箫躜沐蝈玳篝蝙ㄤ邈灬蝈ㄩ珙矧祜徜簌篝屙箫躜沐蝈玳篝蝙┅筢驽豉忉汶珧秕钿泔眄犷－蝻螽轭轸沲蝌孱舡扉箴疳翳＋蝻螽轭轸矧蝻蠛镳Ⅶ狎琏阿蝻蠛镳⑨蜱霭┅ㄣ镯磲钿镳糸镱骘蝽狎珞洪铕豸后趄遽猴豸瘐后趄遽愆ㄤ彐躅蝓瞽扉箴ㄦ矧眢蝈篝狎珞脲祜徜簌篝屙箫躜沐蝈玳篝蝙秕麴豸洪铘弪徙糸鲥┅ㄤ邈灬蝈ㄩ珙矧祜徜簌篝屙箫躜沐蝈玳篝蝙┅蝈礞狎珞猴豸瘐舂筢驽豉箬屐飙泔眄犷－蝻螽轭轸沲蝌孱舡扉箴疳翳＋蝻螽轭轸矧蝻蠛镳Ⅶ狎琏阿蝻蠛镳⑨蜱霭┅ㄣ镯磲钿镳糸镱骘蝽狎珞猴豸瘐秕麴豸┅